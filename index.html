<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èº«ä½“æŒæ§è€… - äº‘ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è·å–ç¯å¢ƒé…ç½®
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'body-master-v1';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // å…¨å±€çŠ¶æ€ç®¡ç†ï¼ˆä¸åŸé€»è¾‘é›†æˆï¼‰
        window.cloudSync = {
            user: null,
            status: 'ç¦»çº¿',
            init: async () => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                await initAuth();
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.cloudSync.user = user;
                        window.cloudSync.status = 'äº‘ç«¯å·²è¿æ¥';
                        document.getElementById('sync-status').innerText = 'â˜ï¸ ' + user.uid.slice(0, 8);
                        // åˆå§‹åŠ è½½äº‘ç«¯æ•°æ®
                        loadFromCloud(user.uid);
                    }
                });
            },
            save: async (data) => {
                if (!window.cloudSync.user) return;
                const userRef = doc(db, 'artifacts', appId, 'users', window.cloudSync.user.uid, 'settings', 'data');
                await setDoc(userRef, data, { merge: true });
            }
        };

        async function loadFromCloud(uid) {
            const userRef = doc(db, 'artifacts', appId, 'users', uid, 'settings', 'data');
            const docSnap = await getDoc(userRef);
            if (docSnap.exists()) {
                const cloudData = docSnap.data();
                // åˆå¹¶é€»è¾‘ï¼šå¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨äº‘ç«¯
                window.state = { ...window.state, ...cloudData };
                window.updateAllUI();
            }
        }

        window.cloudSync.init();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root { --app-max-width: 414px; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f1f5f9;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }
        #app-container {
            width: 100%;
            max-width: var(--app-max-width);
            background-color: #f8fafc;
            position: relative;
            min-height: 100vh;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .fixed-in-container {
            position: fixed;
            width: 100%;
            max-width: var(--app-max-width);
            left: 50%;
            transform: translateX(-50%);
        }
        .task-done { text-decoration: line-through; opacity: 0.5; }
        .page-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .ai-glow { animation: glow 2s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); } to { box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .history-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .history-table th { position: sticky; top: 0; background: #f8fafc; z-index: 10; }
        .history-table td, .history-table th { padding: 12px 8px; font-size: 11px; white-space: nowrap; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>
<body class="text-slate-800">

    <div id="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="fixed-in-container top-0 bg-white/90 backdrop-blur-md z-30 border-b border-slate-100 px-6 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">Body Master</h1>
                <p id="current-date" class="text-[10px] text-slate-400 font-bold uppercase tracking-wider"></p>
            </div>
            <div class="flex items-center gap-2">
                <span id="sync-status" class="text-[9px] font-bold text-slate-300 bg-slate-50 px-2 py-1 rounded-full">æœªç™»å½•</span>
                <button onclick="showSection('ai-assistant')" class="w-10 h-10 rounded-2xl bg-blue-50 text-blue-600 ai-glow flex items-center justify-center active:scale-90 transition-transform">âœ¨</button>
            </div>
        </header>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="pt-24 pb-32 px-4 flex-1 overflow-y-auto no-scrollbar">
            <!-- é¦–é¡µçœ‹æ¿ -->
            <section id="dashboard" class="space-y-6 page-fade-in">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-600 rounded-[2rem] p-5 text-white shadow-xl shadow-blue-100">
                        <p class="text-[10px] font-bold opacity-70 mb-1 uppercase tracking-widest">æ‰§è¡Œç‡</p>
                        <h2 id="execution-rate" class="text-3xl font-black">0%</h2>
                        <div class="mt-4 w-full bg-white/20 rounded-full h-1">
                            <div id="execution-bar" class="bg-white h-1 rounded-full transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-widest">å½“å‰ä½“é‡</p>
                        <div class="flex items-baseline gap-1">
                            <h2 id="current-weight-display" class="text-3xl font-black text-slate-800">--</h2>
                            <span class="text-xs text-slate-400 font-bold">kg</span>
                        </div>
                        <p id="weight-diff" class="text-[10px] mt-2 font-bold"></p>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="flex items-center gap-2 mb-2 text-blue-600">
                        <span class="text-xs font-bold uppercase tracking-widest">ğŸ’¡ å¥èº«è´´å£«</span>
                    </div>
                    <p id="fitness-tip-content" class="text-xs text-slate-600 leading-relaxed font-medium">åŠ è½½ä¸­...</p>
                </div>

                <div class="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700">ä½“é‡è¶‹åŠ¿</h3>
                        <div class="flex gap-2">
                            <button onclick="addWeightLog()" class="text-blue-600 text-[10px] font-bold bg-blue-50 px-3 py-1.5 rounded-full uppercase">è®°å½•ä½“é‡</button>
                        </div>
                    </div>
                    <div class="relative h-44 w-full">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center px-2">
                        <h3 class="font-bold text-slate-700">ä»Šæ—¥å¾…åŠ</h3>
                        <button onclick="showSection('tasks')" class="text-blue-600 text-[10px] font-bold uppercase tracking-widest">å…¨éƒ¨è®¡åˆ’</button>
                    </div>
                    <div id="quick-tasks" class="flex gap-4 overflow-x-auto pb-2 px-1 no-scrollbar"></div>
                </div>
            </section>

            <!-- æ¯æ—¥è®°å½• -->
            <section id="daily-log" class="hidden space-y-6 page-fade-in">
                <h2 class="text-2xl font-black text-slate-800">ä»Šæ—¥è®°å½•</h2>
                <div class="bg-white rounded-3xl p-6 border border-slate-100 space-y-4">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2">ğŸŒ™ ç¡çœ </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="log-sleep-hours" step="0.5" class="bg-slate-50 border-none rounded-xl p-3 text-sm font-bold outline-none" placeholder="æ—¶é•¿(h)">
                        <input type="number" id="log-sleep-quality" min="1" max="5" class="bg-slate-50 border-none rounded-xl p-3 text-sm font-bold outline-none" placeholder="è´¨é‡(1-5)">
                    </div>
                </div>
                <div class="bg-white rounded-3xl p-6 border border-slate-100 space-y-4">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2">ğŸ é¥®é£Ÿ</h3>
                    <div class="space-y-3">
                        <input type="text" id="log-diet-breakfast" class="w-full bg-slate-50 border-none rounded-xl p-3 text-xs outline-none" placeholder="æ—©é¤">
                        <input type="text" id="log-diet-lunch" class="w-full bg-slate-50 border-none rounded-xl p-3 text-xs outline-none" placeholder="åˆé¤">
                        <input type="text" id="log-diet-dinner" class="w-full bg-slate-50 border-none rounded-xl p-3 text-xs outline-none" placeholder="æ™šé¤">
                    </div>
                </div>
                <div class="bg-white rounded-3xl p-6 border border-slate-100 space-y-4">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2">ğŸ’ª è¿åŠ¨</h3>
                    <textarea id="log-exercise-content" class="w-full bg-slate-50 border-none rounded-xl p-4 text-xs outline-none h-24" placeholder="è¿åŠ¨è¯¦æƒ…..."></textarea>
                </div>
                <button onclick="saveDailyLog()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg">ä¿å­˜å¹¶å¤‡ä»½</button>
            </section>

            <!-- å†å²å›é¡¾ -->
            <section id="history" class="hidden space-y-6 page-fade-in">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-black text-slate-800">å†å²</h2>
                    <div class="flex p-1 bg-slate-100 rounded-xl">
                        <button onclick="changeHistoryMode('card')" id="mode-card" class="p-1.5 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg></button>
                        <button onclick="changeHistoryMode('table')" id="mode-table" class="p-1.5 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
                    </div>
                </div>
                <div id="history-container" class="space-y-4"></div>
            </section>

            <!-- è®¡åˆ’æ¸…å• -->
            <section id="tasks" class="hidden space-y-6 page-fade-in">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-black text-slate-800">æ¸…å•</h2>
                    <button onclick="openModal('task-modal')" class="bg-blue-600 text-white p-3 rounded-2xl shadow-lg">æ·»åŠ </button>
                </div>
                <div class="flex p-1 bg-slate-100 rounded-2xl">
                    <button onclick="toggleTaskFilter('daily')" id="tab-daily" class="flex-1 py-2.5 rounded-xl text-xs font-bold bg-white text-blue-600">æ—¥å¸¸</button>
                    <button onclick="toggleTaskFilter('temp')" id="tab-temp" class="flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-500">ä¸´æ—¶</button>
                </div>
                <div id="task-list" class="space-y-3"></div>
            </section>

            <!-- è®¾ç½® -->
            <section id="settings" class="hidden space-y-6 page-fade-in">
                <h2 class="text-2xl font-black text-slate-800">æˆ‘çš„</h2>
                <div class="bg-white rounded-3xl p-6 border border-slate-100 space-y-6">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-widest">ç›®æ ‡ä½“é‡ (kg)</label>
                        <input type="number" id="target-weight" step="0.1" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-lg font-black">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-widest">Gemini API Key</label>
                        <input type="password" id="user-api-key" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm">
                    </div>
                    <button onclick="saveSettings()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">ä¿å­˜åŒæ­¥</button>
                </div>
            </section>
        </main>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <nav class="fixed-in-container bottom-0 bg-white/90 backdrop-blur-lg border-t border-slate-100 px-6 pt-3 pb-6 safe-bottom z-30">
            <div class="flex justify-between items-center text-slate-400">
                <button onclick="showSection('dashboard')" id="nav-dashboard" class="flex-1 flex flex-col items-center gap-1 text-blue-600"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg><span class="text-[9px] font-black uppercase">é¦–é¡µ</span></button>
                <button onclick="showSection('daily-log')" id="nav-daily-log" class="flex-1 flex flex-col items-center gap-1"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg><span class="text-[9px] font-black uppercase">è®°å½•</span></button>
                <button onclick="showSection('tasks')" id="nav-tasks" class="flex-1 flex flex-col items-center gap-1"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3" cy="6" r="1"/><circle cx="3" cy="12" r="1"/><circle cx="3" cy="18" r="1"/></svg><span class="text-[9px] font-black uppercase">è®¡åˆ’</span></button>
                <button onclick="showSection('history')" id="nav-history" class="flex-1 flex flex-col items-center gap-1"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span class="text-[9px] font-black uppercase">å†å²</span></button>
                <button onclick="showSection('settings')" id="nav-settings" class="flex-1 flex flex-col items-center gap-1"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg><span class="text-[9px] font-black uppercase">æˆ‘çš„</span></button>
            </div>
        </nav>

        <!-- å¼¹çª— -->
        <div id="task-modal" class="absolute inset-0 bg-black/40 z-50 hidden flex items-end">
            <div class="bg-white w-full rounded-t-[3rem] p-8 space-y-6 transform translate-y-full transition-transform">
                <input type="text" id="new-task-title" class="w-full bg-slate-50 border-none rounded-2xl p-4 font-bold" placeholder="è®¡åˆ’å†…å®¹">
                <div class="flex gap-4">
                    <select id="new-task-type" class="flex-1 bg-slate-50 border-none rounded-2xl p-4 font-bold"><option value="daily">æ—¥å¸¸</option><option value="temp">ä¸´æ—¶</option></select>
                    <input type="time" id="new-task-time" class="flex-1 bg-slate-50 border-none rounded-2xl p-4 font-bold">
                </div>
                <button onclick="addTask()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold">ç¡®è®¤</button>
                <button onclick="closeModal('task-modal')" class="w-full text-slate-400 font-bold">å–æ¶ˆ</button>
            </div>
        </div>

        <div id="weight-modal" class="absolute inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 space-y-6 transform scale-90">
                <input type="number" id="new-weight-val" step="0.1" class="w-full bg-slate-50 border-none rounded-3xl p-6 text-center text-4xl font-black text-blue-600 outline-none" placeholder="0.0">
                <div class="flex gap-3">
                    <button onclick="closeModal('weight-modal')" class="flex-1 py-4 bg-slate-50 text-slate-400 font-bold rounded-2xl">å–æ¶ˆ</button>
                    <button onclick="confirmWeight()" class="flex-1 py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg">æäº¤</button>
                </div>
            </div>
        </div>

        <div id="toast" class="absolute top-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full text-[10px] font-bold shadow-2xl opacity-0 transition-opacity pointer-events-none z-50"></div>
    </div>

    <script>
        // --- çŠ¶æ€é€»è¾‘ ---
        const DEFAULT_STATE = {
            tasks: [{ id: 1, title: 'æ™¨èµ·ç§°é‡', type: 'daily', time: '07:00', done: false }],
            weightLogs: [{ date: '2024-01-01', weight: 70.0 }],
            dailyLogs: {},
            settings: { targetWeight: 65.0, apiKey: '' },
            currentFilter: 'daily',
            historyMode: 'card'
        };

        const FITNESS_TIPS = [
            "è‚Œè‚‰çš„å¯†åº¦æ¯”è„‚è‚ªå¤§ï¼Œè…°å›´æ›´æœ‰å‚è€ƒä»·å€¼ã€‚",
            "åŠ›é‡è®­ç»ƒèƒ½æé«˜é™æ¯ä»£è°¢ï¼Œè®©ä½ ç¡ç€ä¹Ÿèƒ½ç˜¦ã€‚",
            "æ°´æ˜¯ä»£è°¢çš„åª’ä»‹ã€‚è„±æ°´ä¼šå¯¼è‡´ä»£è°¢ç‡ä¸‹é™ã€‚",
            "ç¡çœ å……è¶³æœ‰åŠ©äºè‚Œè‚‰æ¢å¤å’Œè„‚è‚ªä»£è°¢ã€‚"
        ];

        window.state = JSON.parse(localStorage.getItem('BODY_MASTER_CLOUD')) || DEFAULT_STATE;

        function saveState() {
            localStorage.setItem('BODY_MASTER_CLOUD', JSON.stringify(window.state));
            if (window.cloudSync && window.cloudSync.save) {
                window.cloudSync.save(window.state);
            }
        }

        function getTodayStr() {
            return new Date().toLocaleDateString('zh-CN', { year:'numeric', month:'2-digit', day:'2-digit' }).replace(/\//g, '-');
        }

        // --- UI é›†æˆ ---
        window.updateAllUI = () => {
            renderDashboard();
            renderTasks();
            if(weightChart) updateChart();
            renderHistory();
        };

        function showSection(id) {
            ['dashboard', 'tasks', 'settings', 'ai-assistant', 'history', 'daily-log'].forEach(sec => {
                const el = document.getElementById(sec);
                if(el) el.classList.add('hidden');
                const nav = document.getElementById('nav-' + sec);
                if(nav) nav.classList.replace('text-blue-600', 'text-slate-400');
            });
            document.getElementById(id).classList.remove('hidden');
            if (document.getElementById('nav-' + id)) {
                document.getElementById('nav-' + id).classList.replace('text-slate-400', 'text-blue-600');
            }
            if (id === 'dashboard' && weightChart) setTimeout(() => weightChart.resize(), 50);
            if (id === 'history') renderHistory();
            if (id === 'daily-log') fillDailyLogInputs();
        }

        function changeHistoryMode(mode) {
            window.state.historyMode = mode;
            saveState();
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            const modeCard = document.getElementById('mode-card');
            const modeTable = document.getElementById('mode-table');

            modeCard.className = window.state.historyMode === 'card' ? 'p-1.5 rounded-lg bg-white shadow-sm text-blue-600' : 'p-1.5 rounded-lg text-slate-400';
            modeTable.className = window.state.historyMode === 'table' ? 'p-1.5 rounded-lg bg-white shadow-sm text-blue-600' : 'p-1.5 rounded-lg text-slate-400';

            const allDates = Array.from(new Set([...window.state.weightLogs.map(l => l.date), ...Object.keys(window.state.dailyLogs)])).sort().reverse();

            if (window.state.historyMode === 'card') {
                container.innerHTML = allDates.map(date => {
                    const weightLog = window.state.weightLogs.find(l => l.date === date);
                    const dailyLog = window.state.dailyLogs[date];
                    return `
                        <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 space-y-3">
                            <div class="flex justify-between items-center" onclick="toggleDetail('${date}')">
                                <span class="text-xs font-black text-slate-800">${date}</span>
                                <span class="text-xs text-blue-600 font-bold">${weightLog ? weightLog.weight + 'kg' : ''}</span>
                            </div>
                            <div id="det-${date}" class="hidden pt-2 border-t text-[11px] space-y-2">
                                ${dailyLog?.sleep?.h ? `<div>ç¡çœ : ${dailyLog.sleep.h}h</div>` : ''}
                                ${dailyLog?.exercise ? `<div>è¿åŠ¨: ${dailyLog.exercise}</div>` : ''}
                                <button onclick="deleteDay('${date}')" class="text-red-300">åˆ é™¤è®°å½•</button>
                            </div>
                        </div>`;
                }).join('');
            } else {
                container.innerHTML = `<div class="bg-white rounded-3xl overflow-hidden border overflow-x-auto"><table class="history-table"><thead><tr class="bg-slate-50"><th>æ—¥æœŸ</th><th>ä½“é‡</th><th>ç¡çœ </th><th>é¥®é£Ÿ</th><th>æ“ä½œ</th></tr></thead><tbody>${allDates.map(date => {
                    const weightLog = window.state.weightLogs.find(l => l.date === date);
                    const dailyLog = window.state.dailyLogs[date];
                    return `<tr><td>${date.slice(5)}</td><td class="text-blue-600">${weightLog ? weightLog.weight : '--'}</td><td>${dailyLog?.sleep?.h ? dailyLog.sleep.h + 'h' : '--'}</td><td class="max-w-[80px] truncate">${dailyLog?.exercise || '--'}</td><td><button onclick="deleteDay('${date}')">âœ•</button></td></tr>`;
                }).join('')}</tbody></table></div>`;
            }
        }

        function toggleDetail(date) { const el = document.getElementById(`det-${date}`); if(el) el.classList.toggle('hidden'); }
        function deleteDay(date) { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { window.state.weightLogs = window.state.weightLogs.filter(l => l.date !== date); delete window.state.dailyLogs[date]; saveState(); renderHistory(); renderDashboard(); } }

        function fillDailyLogInputs() {
            const today = getTodayStr();
            const log = window.state.dailyLogs[today] || {};
            document.getElementById('log-sleep-hours').value = log.sleep?.h || '';
            document.getElementById('log-diet-breakfast').value = log.diet?.b || '';
            document.getElementById('log-exercise-content').value = log.exercise || '';
        }

        function saveDailyLog() {
            const today = getTodayStr();
            window.state.dailyLogs[today] = {
                sleep: { h: document.getElementById('log-sleep-hours').value },
                diet: { b: document.getElementById('log-diet-breakfast').value },
                exercise: document.getElementById('log-exercise-content').value
            };
            saveState();
            showToast("åŒæ­¥æˆåŠŸ");
            showSection('dashboard');
        }

        function renderDashboard() {
            const done = window.state.tasks.filter(t => t.done).length;
            const rate = window.state.tasks.length > 0 ? Math.round((done / window.state.tasks.length) * 100) : 0;
            document.getElementById('execution-rate').innerText = rate + '%';
            document.getElementById('execution-bar').style.width = rate + '%';
            const current = window.state.weightLogs[window.state.weightLogs.length - 1].weight;
            document.getElementById('current-weight-display').innerText = current ? current.toFixed(1) : '--';
            document.getElementById('quick-tasks').innerHTML = window.state.tasks.filter(t => !t.done).map(t => `<div class="flex-shrink-0 w-32 bg-white p-4 rounded-3xl border" onclick="toggleTask(${t.id})"><p class="text-[10px] font-black">${t.title}</p></div>`).join('') || '<p class="p-4 text-xs text-slate-300">é€šå…³!</p>';
        }

        function toggleTask(id) { const t = window.state.tasks.find(x => x.id === id); if(t) { t.done = !t.done; saveState(); renderDashboard(); renderTasks(); } }
        function addTask() { const title = document.getElementById('new-task-title').value; if(!title) return; window.state.tasks.push({ id: Date.now(), title, type: document.getElementById('new-task-type').value, time: document.getElementById('new-task-time').value, done: false }); saveState(); closeModal('task-modal'); renderTasks(); renderDashboard(); }
        function deleteTask(e, id) { e.stopPropagation(); window.state.tasks = window.state.tasks.filter(t => t.id !== id); saveState(); renderTasks(); renderDashboard(); }
        function confirmWeight() { const v = parseFloat(document.getElementById('new-weight-val').value); if(v > 0) { const today = getTodayStr(); const idx = window.state.weightLogs.findIndex(l => l.date === today); if(idx > -1) window.state.weightLogs[idx].weight = v; else window.state.weightLogs.push({ date: today, weight: v }); saveState(); closeModal('weight-modal'); updateChart(); renderDashboard(); } }
        function saveSettings() { window.state.settings.targetWeight = parseFloat(document.getElementById('target-weight').value); window.state.settings.apiKey = document.getElementById('user-api-key').value; saveState(); showToast('è®¾ç½®åŒæ­¥'); showSection('dashboard'); }

        let weightChart = null;
        function initChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(ctx, { type: 'line', data: { labels: window.state.weightLogs.slice(-10).map(l => l.date.slice(-5)), datasets: [{ data: window.state.weightLogs.slice(-10).map(l => l.weight), borderColor: '#2563eb', borderWidth: 4, tension: 0.4, fill: false, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 8 } } } } } });
        }
        function updateChart() { 
            if(!weightChart) return;
            weightChart.data.labels = window.state.weightLogs.slice(-10).map(l => l.date.slice(-5)); 
            weightChart.data.datasets[0].data = window.state.weightLogs.slice(-10).map(l => l.weight); 
            weightChart.update(); 
        }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); setTimeout(()=>document.getElementById(id).firstElementChild.classList.remove('translate-y-full', 'scale-90'), 10); }
        function closeModal(id) { document.getElementById(id).firstElementChild.classList.add('translate-y-full', 'scale-90'); setTimeout(()=>document.getElementById(id).classList.add('hidden'), 300); }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.replace('opacity-0', 'opacity-100'); setTimeout(()=>t.classList.replace('opacity-100', 'opacity-0'), 2000); }
        function resetApp() { if(confirm("é‡ç½®å—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
        function addWeightLog() { openModal('weight-modal'); }
        function renderTasks() { const list = document.getElementById('task-list'); list.innerHTML = window.state.tasks.map(t => `<div class="bg-white p-5 rounded-3xl flex items-center gap-4" onclick="toggleTask(${t.id})"><div class="w-6 h-6 rounded-full border-4 ${t.done ? 'bg-blue-600 border-blue-100' : 'border-slate-50'}"></div><div class="flex-1"><p class="text-xs font-black ${t.done ? 'task-done' : ''}">${t.title}</p></div><button onclick="deleteTask(event, ${t.id})">âœ•</button></div>`).join(''); }

        // å®šä¹‰ renderFitnessTip å‡½æ•°
        function renderFitnessTip() {
            const tipEl = document.getElementById('fitness-tip-content');
            if (tipEl && FITNESS_TIPS.length > 0) {
                const randomTip = FITNESS_TIPS[Math.floor(Math.random() * FITNESS_TIPS.length)];
                tipEl.innerText = randomTip;
            }
        }

        window.onload = () => {
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', weekday: 'short' });
            document.getElementById('target-weight').value = window.state.settings.targetWeight;
            document.getElementById('user-api-key').value = window.state.settings.apiKey;
            window.updateAllUI();
            initChart();
            renderFitnessTip(); // ç°åœ¨è¯¥å‡½æ•°å·²å®šä¹‰
        };
    </script>
</body>
</html>
