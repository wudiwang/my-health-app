<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èº«ä½“æŒæ§è€… - ä¸ªäººè½åœ°ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root { --app-max-width: 414px; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f1f5f9;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }
        #app-container {
            width: 100%;
            max-width: var(--app-max-width);
            background-color: #f8fafc;
            position: relative;
            min-height: 100vh;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .fixed-in-container {
            position: fixed;
            width: 100%;
            max-width: var(--app-max-width);
            left: 50%;
            transform: translateX(-50%);
        }
        .task-done { text-decoration: line-through; opacity: 0.5; }
        .page-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .ai-glow { animation: glow 2s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); } to { box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-slate-800">

    <div id="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="fixed-in-container top-0 bg-white/90 backdrop-blur-md z-30 border-b border-slate-100 px-6 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">Body Master</h1>
                <p id="current-date" class="text-[10px] text-slate-400 font-bold uppercase tracking-wider"></p>
            </div>
            <button onclick="showSection('ai-assistant')" class="w-10 h-10 rounded-2xl bg-blue-50 text-blue-600 ai-glow flex items-center justify-center active:scale-90 transition-transform">âœ¨</button>
        </header>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="pt-24 pb-32 px-4 flex-1 overflow-y-auto no-scrollbar">
            
            <!-- é¦–é¡µçœ‹æ¿ -->
            <section id="dashboard" class="space-y-6 page-fade-in">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-600 rounded-[2rem] p-5 text-white shadow-xl shadow-blue-100">
                        <p class="text-[10px] font-bold opacity-70 mb-1 uppercase tracking-widest">Execution</p>
                        <h2 id="execution-rate" class="text-3xl font-black">0%</h2>
                        <div class="mt-4 w-full bg-white/20 rounded-full h-1">
                            <div id="execution-bar" class="bg-white h-1 rounded-full transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-widest">Weight</p>
                        <div class="flex items-baseline gap-1">
                            <h2 id="current-weight-display" class="text-3xl font-black text-slate-800">--</h2>
                            <span class="text-xs text-slate-400 font-bold">kg</span>
                        </div>
                        <p id="weight-diff" class="text-[10px] mt-2 font-bold"></p>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-3xl p-5 border border-blue-100">
                    <div class="flex items-center gap-2 mb-2 text-blue-600">
                        <span class="text-sm font-bold">âœ¨ ä»Šæ—¥ AI å»ºè®®</span>
                    </div>
                    <p id="ai-daily-brief" class="text-xs text-slate-600 leading-relaxed italic">è®¾ç½® API Key åå³å¯è·å¾— AI æ·±åº¦ç‚¹è¯„...</p>
                </div>

                <div class="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700">è¶‹åŠ¿</h3>
                        <button onclick="addWeightLog()" class="text-blue-600 text-xs font-bold bg-blue-50 px-3 py-1.5 rounded-full">è®°å½•ä½“é‡</button>
                    </div>
                    <div class="relative h-44 w-full">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center px-2">
                        <h3 class="font-bold text-slate-700">å¾…åŠ</h3>
                        <button onclick="showSection('tasks')" class="text-blue-600 text-[10px] font-bold uppercase tracking-widest">æŸ¥çœ‹å…¨éƒ¨</button>
                    </div>
                    <div id="quick-tasks" class="flex gap-4 overflow-x-auto pb-2 px-1 no-scrollbar"></div>
                </div>
            </section>

            <!-- è®¡åˆ’æ¸…å• -->
            <section id="tasks" class="hidden space-y-6 page-fade-in">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-2xl font-black text-slate-800">è®¡åˆ’æ¸…å•</h2>
                    <button onclick="openModal('task-modal')" class="bg-blue-600 text-white p-3 rounded-2xl shadow-lg active:scale-90 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <div class="flex p-1 bg-slate-100 rounded-2xl">
                    <button onclick="toggleTaskFilter('daily')" id="tab-daily" class="flex-1 py-2.5 rounded-xl text-xs font-bold bg-white shadow-sm text-blue-600 transition-all">æ—¥å¸¸</button>
                    <button onclick="toggleTaskFilter('temp')" id="tab-temp" class="flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-500 transition-all">ä¸´æ—¶</button>
                </div>
                <div id="task-list" class="space-y-3"></div>
            </section>

            <!-- AI åŠ©æ‰‹ -->
            <section id="ai-assistant" class="hidden space-y-6 page-fade-in">
                <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100 text-center">
                    <div class="w-16 h-16 bg-blue-50 rounded-3xl flex items-center justify-center text-3xl mx-auto mb-4">âœ¨</div>
                    <h2 class="text-xl font-black">AI æ™ºèƒ½æ•™ç»ƒ</h2>
                    <p class="text-xs text-slate-400 mt-2">åŸºäº Gemini 2.5 ä¸ºæ‚¨åˆ†æèº«ä½“å¯†ç </p>
                </div>

                <div class="bg-white rounded-3xl p-6 border border-slate-100 space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2">ğŸ¥— é¥®é£Ÿåˆ†æ</h3>
                        <span id="ai-diet-indicator" class="text-[10px] bg-amber-100 text-amber-600 px-2 py-0.5 rounded-md font-bold hidden">åˆ†æä¸­</span>
                    </div>
                    <textarea id="ai-diet-input" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-xs font-medium outline-none h-24 focus:ring-2 focus:ring-blue-100" placeholder="åƒäº†ä»€ä¹ˆï¼Ÿä¾‹å¦‚ï¼šåˆé¤åŠç¢—ç±³é¥­ã€ä¸€ä»½æ¸…è’¸é±¼ã€ä¸€ç¢—é’èœ..."></textarea>
                    <button onclick="analyzeDiet()" id="btn-diet-ai" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-100 active:scale-95 transition-transform flex justify-center items-center gap-2 text-sm">
                        <span>å¼€å§‹ AI ç‚¹è¯„</span>
                    </button>
                    <div id="ai-diet-result" class="hidden text-xs text-slate-600 leading-relaxed bg-blue-50 p-4 rounded-2xl border border-blue-100"></div>
                </div>

                <button onclick="getBreakthroughAdvice()" id="btn-break-ai" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-bold shadow-xl active:scale-95 transition-all text-sm flex items-center justify-center gap-2">
                    âš¡ ç ´è§£ä½“é‡é”šç‚¹å»ºè®®
                </button>
                <div id="ai-break-result" class="hidden text-xs text-slate-600 leading-relaxed bg-indigo-50 p-5 rounded-3xl border border-indigo-100"></div>
            </section>

            <!-- è®¾ç½® -->
            <section id="settings" class="hidden space-y-6 page-fade-in">
                <h2 class="text-2xl font-black text-slate-800">æˆ‘çš„é…ç½®</h2>
                
                <div class="bg-white rounded-3xl p-6 border border-slate-100 space-y-6">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">ç›®æ ‡ä½“é‡ (kg)</label>
                        <input type="number" id="target-weight" step="0.1" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-lg font-black outline-none focus:ring-2 focus:ring-blue-100">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Gemini API Key</label>
                        <input type="password" id="user-api-key" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-medium outline-none focus:ring-2 focus:ring-blue-100" placeholder="åœ¨æ­¤å¡«å…¥ä½ çš„ API Key">
                    </div>
                    <button onclick="saveSettings()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold active:scale-95 transition-all">ä¿å­˜å¹¶åº”ç”¨</button>
                </div>

                <div class="bg-red-50 rounded-3xl p-6 border border-red-100">
                    <p class="text-xs text-red-600 font-bold mb-3">æ•°æ®ç®¡ç†</p>
                    <button onclick="resetApp()" class="text-xs text-red-400 underline font-bold">é‡ç½®åº”ç”¨å¹¶æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®</button>
                </div>
            </section>
        </main>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <nav class="fixed-in-container bottom-0 bg-white/90 backdrop-blur-lg border-t border-slate-100 px-8 pt-3 pb-6 safe-bottom z-30">
            <div class="flex justify-between items-center">
                <button onclick="showSection('dashboard')" id="nav-dashboard" class="flex flex-col items-center gap-1 text-blue-600">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
                    <span class="text-[9px] font-black uppercase tracking-tighter">é¦–é¡µ</span>
                </button>
                <button onclick="showSection('tasks')" id="nav-tasks" class="flex flex-col items-center gap-1 text-slate-400">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3" cy="6" r="1"/><circle cx="3" cy="12" r="1"/><circle cx="3" cy="18" r="1"/></svg>
                    <span class="text-[9px] font-black uppercase tracking-tighter">è®¡åˆ’</span>
                </button>
                <button onclick="showSection('settings')" id="nav-settings" class="flex flex-col items-center gap-1 text-slate-400">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                    <span class="text-[9px] font-black uppercase tracking-tighter">æˆ‘çš„</span>
                </button>
            </div>
        </nav>

        <!-- æ¨¡æ€æ¡†ï¼šæ·»åŠ ä»»åŠ¡ -->
        <div id="task-modal" class="absolute inset-0 bg-black/40 z-50 hidden flex items-end">
            <div class="bg-white w-full rounded-t-[3rem] p-8 space-y-6 transform translate-y-full transition-transform duration-300">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-black">æ–°å¢è®¡åˆ’</h3>
                    <button onclick="closeModal('task-modal')" class="p-2 bg-slate-100 rounded-full text-slate-400">âœ•</button>
                </div>
                <div class="space-y-4">
                    <input type="text" id="new-task-title" class="w-full bg-slate-50 border-none rounded-2xl p-4 font-bold outline-none" placeholder="å†…å®¹ (å¦‚: æ™šé¤ä¸åƒä¸»é£Ÿ)">
                    <div class="flex gap-4">
                        <select id="new-task-type" class="flex-1 bg-slate-50 border-none rounded-2xl p-4 font-bold outline-none">
                            <option value="daily">æ¯æ—¥æƒ¯ä¾‹</option>
                            <option value="temp">ä¸´æ—¶ä»»åŠ¡</option>
                        </select>
                        <input type="time" id="new-task-time" class="flex-1 bg-slate-50 border-none rounded-2xl p-4 font-bold outline-none">
                    </div>
                    <button onclick="addTask()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg mt-4">ç¡®è®¤</button>
                </div>
            </div>
        </div>

        <div id="weight-modal" class="absolute inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 space-y-6 transform scale-90 transition-all">
                <h3 class="text-lg font-black text-center">è®°å½•ä½“é‡</h3>
                <div class="relative">
                    <input type="number" id="new-weight-val" step="0.1" class="w-full bg-slate-50 border-none rounded-3xl p-6 text-center text-4xl font-black text-blue-600 outline-none" placeholder="0.0">
                    <span class="absolute right-6 top-1/2 -translate-y-1/2 text-slate-300 font-bold">kg</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeModal('weight-modal')" class="flex-1 py-4 rounded-2xl font-bold bg-slate-50 text-slate-400">å–æ¶ˆ</button>
                    <button onclick="confirmWeight()" class="flex-1 py-4 rounded-2xl font-bold bg-blue-600 text-white shadow-lg">æäº¤</button>
                </div>
            </div>
        </div>

        <div id="toast" class="absolute top-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full text-[10px] font-bold shadow-2xl opacity-0 transition-opacity pointer-events-none z-50 uppercase tracking-widest"></div>
    </div>

    <script>
        // --- æ ¸å¿ƒçŠ¶æ€ä¸æŒä¹…åŒ–é€»è¾‘ ---
        const DEFAULT_STATE = {
            tasks: [
                { id: 1, title: 'æ™¨èµ·ç§°é‡', type: 'daily', time: '07:00', done: false },
                { id: 2, title: 'ç©ºè…¹é¥®æ°´ 500ml', type: 'daily', time: '07:15', done: false }
            ],
            weightLogs: [{ date: '2024-01-01', weight: 70.0 }],
            settings: { targetWeight: 65.0, apiKey: '' },
            currentFilter: 'daily'
        };

        let state = JSON.parse(localStorage.getItem('BODY_MASTER_DATA')) || DEFAULT_STATE;

        function saveToLocal() {
            localStorage.setItem('BODY_MASTER_DATA', JSON.stringify(state));
        }

        // --- Gemini API æ¨¡å— ---
        async function callGemini(prompt, systemMsg = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¥åº·æ•™ç»ƒã€‚è¯·ç”¨ 50 å­—ä»¥å†…ç»™å‡ºå»ºè®®ã€‚") {
            const key = state.settings.apiKey;
            if (!key) return "è¯·å…ˆåœ¨â€œæˆ‘çš„â€é¡µé¢è®¾ç½® API Keyã€‚";

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemMsg }] }
            };

            try {
                const res = await fetch(url, { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key æˆ–ç½‘ç»œã€‚";
            } catch (e) { return "ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è¿æ¥ AIã€‚"; }
        }

        // --- UI æ¸²æŸ“é€»è¾‘ ---
        let weightChart = null;

        window.onload = () => {
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', weekday: 'short' });
            
            document.getElementById('target-weight').value = state.settings.targetWeight;
            document.getElementById('user-api-key').value = state.settings.apiKey;

            renderDashboard();
            renderTasks();
            initChart();
            generateDailyBrief();
        };

        function showSection(id) {
            ['dashboard', 'tasks', 'settings', 'ai-assistant'].forEach(sec => {
                const el = document.getElementById(sec);
                if(el) el.classList.add('hidden');
                const nav = document.getElementById('nav-' + (sec === 'ai-assistant' ? 'dashboard' : sec));
                if(nav) nav.classList.replace('text-blue-600', 'text-slate-400');
            });
            document.getElementById(id).classList.remove('hidden');
            if (id !== 'ai-assistant') document.getElementById('nav-' + id).classList.replace('text-slate-400', 'text-blue-600');
            if (id === 'dashboard' && weightChart) setTimeout(() => weightChart.resize(), 50);
        }

        function renderDashboard() {
            const done = state.tasks.filter(t => t.done).length;
            const rate = state.tasks.length > 0 ? Math.round((done / state.tasks.length) * 100) : 0;
            document.getElementById('execution-rate').innerText = rate + '%';
            document.getElementById('execution-bar').style.width = rate + '%';
            
            const current = state.weightLogs[state.weightLogs.length - 1].weight;
            document.getElementById('current-weight-display').innerText = current.toFixed(1);
            
            const diff = (current - (state.weightLogs[state.weightLogs.length - 2]?.weight || current)).toFixed(1);
            const diffEl = document.getElementById('weight-diff');
            diffEl.innerText = diff > 0 ? `+${diff} kg` : diff < 0 ? `${diff} kg` : 'UNCHANGED';
            diffEl.className = `text-[10px] mt-2 font-black ${diff > 0 ? 'text-red-400' : diff < 0 ? 'text-emerald-400' : 'text-slate-300'}`;

            document.getElementById('quick-tasks').innerHTML = state.tasks.filter(t => !t.done).map(t => `
                <div class="flex-shrink-0 w-32 bg-white p-4 rounded-[1.5rem] border border-slate-100 shadow-sm" onclick="toggleTask(${t.id})">
                    <p class="text-[10px] font-black text-slate-800 truncate uppercase">${t.title}</p>
                    <p class="text-[9px] text-slate-400 font-bold mt-1">${t.time}</p>
                </div>
            `).join('') || '<p class="text-[10px] text-slate-300 font-bold p-4">ALL TASKS DONE!</p>';
        }

        async function generateDailyBrief() {
            if (!state.settings.apiKey) return;
            const cur = state.weightLogs[state.weightLogs.length-1].weight;
            const res = await callGemini(`ä½“é‡${cur}kg, ç›®æ ‡${state.settings.targetWeight}kg, ä»Šæ—¥å®Œæˆ${state.tasks.filter(t=>t.done).length}ä¸ªä»»åŠ¡ã€‚è¯·é¼“åŠ±æˆ‘ã€‚`);
            document.getElementById('ai-daily-brief').textContent = res;
        }

        function toggleTaskFilter(type) {
            state.currentFilter = type;
            document.getElementById('tab-daily').className = `flex-1 py-2.5 rounded-xl text-xs font-bold ${type==='daily'?'bg-white shadow-sm text-blue-600':'text-slate-500'}`;
            document.getElementById('tab-temp').className = `flex-1 py-2.5 rounded-xl text-xs font-bold ${type==='temp'?'bg-white shadow-sm text-blue-600':'text-slate-500'}`;
            renderTasks();
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            const filtered = state.tasks.filter(t => t.type === state.currentFilter);
            list.innerHTML = filtered.map(t => `
                <div class="bg-white p-5 rounded-3xl flex items-center gap-4 shadow-sm" onclick="toggleTask(${t.id})">
                    <div class="w-6 h-6 rounded-full border-4 ${t.done ? 'bg-blue-600 border-blue-100' : 'border-slate-50'} transition-all"></div>
                    <div class="flex-1">
                        <p class="text-xs font-black text-slate-700 ${t.done ? 'task-done' : ''}">${t.title}</p>
                        <p class="text-[9px] text-slate-300 font-bold uppercase">${t.time}</p>
                    </div>
                    <button onclick="deleteTask(event, ${t.id})" class="text-slate-200 text-xs">âœ•</button>
                </div>
            `).join('');
        }

        function toggleTask(id) {
            const t = state.tasks.find(x => x.id === id);
            if(t) { t.done = !t.done; saveToLocal(); renderTasks(); renderDashboard(); }
        }

        function addTask() {
            const title = document.getElementById('new-task-title').value;
            if(!title) return;
            state.tasks.push({ id: Date.now(), title, type: document.getElementById('new-task-type').value, time: document.getElementById('new-task-time').value || '--:--', done: false });
            saveToLocal(); closeModal('task-modal'); renderTasks(); renderDashboard();
        }

        function deleteTask(e, id) { e.stopPropagation(); state.tasks = state.tasks.filter(t => t.id !== id); saveToLocal(); renderTasks(); renderDashboard(); }

        function saveSettings() {
            state.settings.targetWeight = parseFloat(document.getElementById('target-weight').value);
            state.settings.apiKey = document.getElementById('user-api-key').value;
            saveToLocal(); showToast('è®¾ç½®å·²åŒæ­¥'); showSection('dashboard'); generateDailyBrief();
        }

        function confirmWeight() {
            const v = parseFloat(document.getElementById('new-weight-val').value);
            if(v > 0) {
                state.weightLogs.push({ date: new Date().toLocaleDateString(), weight: v });
                if(state.weightLogs.length > 10) state.weightLogs.shift();
                saveToLocal(); closeModal('weight-modal'); updateChart(); renderDashboard(); generateDailyBrief();
            }
        }

        function initChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: state.weightLogs.map(l => l.date.slice(-5)),
                    datasets: [{ data: state.weightLogs.map(l => l.weight), borderColor: '#2563eb', borderWidth: 4, tension: 0.4, fill: false, pointRadius: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 8, weight: 'bold' }, color: '#cbd5e1' } } } }
            });
        }
        function updateChart() { weightChart.data.labels = state.weightLogs.map(l => l.date.slice(-5)); weightChart.data.datasets[0].data = state.weightLogs.map(l => l.weight); weightChart.update(); }

        async function analyzeDiet() {
            const inp = document.getElementById('ai-diet-input').value;
            if(!inp) return;
            const resEl = document.getElementById('ai-diet-result');
            resEl.classList.remove('hidden');
            resEl.textContent = "AI æ­£åœ¨è®¡ç®—è¥å…»æˆåˆ†...";
            const res = await callGemini(`æˆ‘åƒäº†ï¼š${inp}ã€‚è¯·è¯„ä»·çƒ­é‡å’Œå‡è¡¡åº¦ã€‚`);
            resEl.textContent = res;
        }

        async function getBreakthroughAdvice() {
            const resEl = document.getElementById('ai-break-result');
            resEl.classList.remove('hidden');
            resEl.textContent = "åˆ†ææœ€è¿‘ä½“é‡è¶‹åŠ¿ä¸­...";
            const res = await callGemini("æˆ‘æ„Ÿè§‰é‡åˆ°äº†ä½“é‡é”šç‚¹ï¼Œè¯·æ ¹æ®æˆ‘çš„è®°å½•ç»™æˆ‘ä¸€ä¸ªçªç ´æ–¹æ¡ˆã€‚");
            resEl.textContent = res;
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); setTimeout(()=>document.getElementById(id).firstElementChild.classList.remove('translate-y-full', 'scale-90'), 10); }
        function closeModal(id) { document.getElementById(id).firstElementChild.classList.add('translate-y-full', 'scale-90'); setTimeout(()=>document.getElementById(id).classList.add('hidden'), 300); }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.replace('opacity-0', 'opacity-100'); setTimeout(()=>t.classList.replace('opacity-100', 'opacity-0'), 2000); }
        function resetApp() { if(confirm("ç¡®å®šè¦åˆ é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
        function addWeightLog() { openModal('weight-modal'); }
    </script>
</body>
</html>