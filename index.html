<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èº«ä½“æŒæ§è€… - å…¨èƒ½è®°å½•ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root { --app-max-width: 414px; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f1f5f9;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }
        #app-container {
            width: 100%;
            max-width: var(--app-max-width);
            background-color: #f8fafc;
            position: relative;
            min-height: 100vh;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .fixed-in-container {
            position: fixed;
            width: 100%;
            max-width: var(--app-max-width);
            left: 50%;
            transform: translateX(-50%);
        }
        .task-done { text-decoration: line-through; opacity: 0.5; }
        .page-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .ai-glow { animation: glow 2s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); } to { box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        input::placeholder, textarea::placeholder { font-size: 0.8rem; opacity: 0.5; }

        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
        .history-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .history-table th { position: sticky; top: 0; background: #f8fafc; z-index: 10; }
        .history-table td, .history-table th { padding: 12px 8px; font-size: 11px; white-space: nowrap; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>
<body class="text-slate-800">

    <div id="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="fixed-in-container top-0 bg-white/90 backdrop-blur-md z-30 border-b border-slate-100 px-6 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">Body Master</h1>
                <p id="current-date" class="text-[10px] text-slate-400 font-bold uppercase tracking-wider"></p>
            </div>
            <button onclick="showSection('ai-assistant')" class="w-10 h-10 rounded-2xl bg-blue-50 text-blue-600 ai-glow flex items-center justify-center active:scale-90 transition-transform">âœ¨</button>
        </header>

        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="pt-24 pb-32 px-4 flex-1 overflow-y-auto no-scrollbar">
            
            <!-- é¦–é¡µçœ‹æ¿ -->
            <section id="dashboard" class="space-y-6 page-fade-in">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-600 rounded-[2rem] p-5 text-white shadow-xl shadow-blue-100">
                        <p class="text-[10px] font-bold opacity-70 mb-1 uppercase tracking-widest">æ‰§è¡Œç‡</p>
                        <h2 id="execution-rate" class="text-3xl font-black">0%</h2>
                        <div class="mt-4 w-full bg-white/20 rounded-full h-1">
                            <div id="execution-bar" class="bg-white h-1 rounded-full transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-widest">å½“å‰ä½“é‡</p>
                        <div class="flex items-baseline gap-1">
                            <h2 id="current-weight-display" class="text-3xl font-black text-slate-800">--</h2>
                            <span class="text-xs text-slate-400 font-bold">kg</span>
                        </div>
                        <p id="weight-diff" class="text-[10px] mt-2 font-bold"></p>
                    </div>
                </div>

                <!-- å¥èº«å°çŸ¥è¯†å¡ç‰‡ -->
                <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 relative overflow-hidden group">
                    <div class="flex items-center gap-2 mb-2 text-blue-600">
                        <span class="text-xs font-bold uppercase tracking-widest">ğŸ’¡ å¥èº«è´´å£«</span>
                    </div>
                    <p id="fitness-tip-content" class="text-xs text-slate-600 leading-relaxed font-medium">åŠ è½½ä¸­...</p>
                </div>

                <div class="bg-white rounded-[2rem] p-5 shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700">ä½“é‡è¶‹åŠ¿</h3>
                        <div class="flex gap-2">
                            <button onclick="addWeightLog()" class="text-blue-600 text-[10px] font-bold bg-blue-50 px-3 py-1.5 rounded-full uppercase">è®°å½•ä½“é‡</button>
                        </div>
                    </div>
                    <div class="relative h-44 w-full">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center px-2">
                        <h3 class="font-bold text-slate-700">ä»Šæ—¥å¾…åŠ</h3>
                        <button onclick="showSection('tasks')" class="text-blue-600 text-[10px] font-bold uppercase tracking-widest">å…¨éƒ¨è®¡åˆ’</button>
                    </div>
                    <div id="quick-tasks" class="flex gap-4 overflow-x-auto pb-2 px-1 no-scrollbar"></div>
                </div>
            </section>

            <!-- æ¯æ—¥è®°å½• -->
            <section id="daily-log" class="hidden space-y-6 page-fade-in">
                <h2 class="text-2xl font-black text-slate-800">ä»Šæ—¥èº«ä½“è®°å½•</h2>
                
                <div class="bg-white rounded-3xl p-6 border border-slate-100 space-y-4">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2">ğŸŒ™ ç¡çœ æƒ…å†µ</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-slate-400 font-bold uppercase mb-1 block">æ—¶é•¿ (å°æ—¶)</label>
                            <input type="number" id="log-sleep-hours" step="0.5" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-bold outline-none" placeholder="å¦‚: 7.5">
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-400 font-bold uppercase mb-1 block">è´¨é‡è¯„åˆ† (1-5)</label>
                            <input type="number" id="log-sleep-quality" min="1" max="5" class="w-full bg-slate-50 border-none rounded-xl p-3 text-sm font-bold outline-none" placeholder="1-5">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-6 border border-slate-100 space-y-4">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2">ğŸ é¥®é£Ÿæ¸…å•</h3>
                    <div class="space-y-3">
                        <input type="text" id="log-diet-breakfast" class="w-full bg-slate-50 border-none rounded-xl p-3 text-xs font-medium outline-none" placeholder="æ—©é¤: åƒäº†ä»€ä¹ˆï¼Ÿ">
                        <input type="text" id="log-diet-lunch" class="w-full bg-slate-50 border-none rounded-xl p-3 text-xs font-medium outline-none" placeholder="åˆé¤: åƒäº†ä»€ä¹ˆï¼Ÿ">
                        <input type="text" id="log-diet-dinner" class="w-full bg-slate-50 border-none rounded-xl p-3 text-xs font-medium outline-none" placeholder="æ™šé¤: åƒäº†ä»€ä¹ˆï¼Ÿ">
                        <input type="text" id="log-diet-snack" class="w-full bg-slate-50 border-none rounded-xl p-3 text-xs font-medium outline-none" placeholder="åŠ é¤/é›¶é£Ÿ: åƒäº†ä»€ä¹ˆï¼Ÿ">
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-6 border border-slate-100 space-y-4">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2">ğŸ’ª è¿åŠ¨è¡¨ç°</h3>
                    <textarea id="log-exercise-content" class="w-full bg-slate-50 border-none rounded-xl p-4 text-xs font-medium outline-none h-24" placeholder="ä»Šå¤©åšäº†ä»€ä¹ˆè¿åŠ¨ï¼Ÿå¼ºåº¦å¦‚ä½•ï¼Ÿä¾‹å¦‚ï¼šè·‘æ­¥ 5kmï¼Œé…é€Ÿ 6'00''"></textarea>
                </div>

                <button onclick="saveDailyLog()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-100 active:scale-95 transition-all">ä¿å­˜ä»Šæ—¥è®°å½•</button>
            </section>

            <!-- å†å²æ•°æ® (UPGRADED with Toggle) -->
            <section id="history" class="hidden space-y-6 page-fade-in">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-black text-slate-800">å†å²å›é¡¾</h2>
                    <!-- æŸ¥çœ‹æ¨¡å¼åˆ‡æ¢ -->
                    <div class="flex p-1 bg-slate-100 rounded-xl">
                        <button onclick="changeHistoryMode('card')" id="mode-card" class="p-1.5 rounded-lg transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
                        </button>
                        <button onclick="changeHistoryMode('table')" id="mode-table" class="p-1.5 rounded-lg transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                        </button>
                    </div>
                </div>

                <!-- å†…å®¹å®¹å™¨ -->
                <div id="history-container" class="space-y-4">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </div>
            </section>

            <!-- è®¡åˆ’æ¸…å• -->
            <section id="tasks" class="hidden space-y-6 page-fade-in">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-2xl font-black text-slate-800">è®¡åˆ’æ¸…å•</h2>
                    <button onclick="openModal('task-modal')" class="bg-blue-600 text-white p-3 rounded-2xl shadow-lg active:scale-90 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <div class="flex p-1 bg-slate-100 rounded-2xl">
                    <button onclick="toggleTaskFilter('daily')" id="tab-daily" class="flex-1 py-2.5 rounded-xl text-xs font-bold bg-white shadow-sm text-blue-600 transition-all">æ—¥å¸¸</button>
                    <button onclick="toggleTaskFilter('temp')" id="tab-temp" class="flex-1 py-2.5 rounded-xl text-xs font-bold text-slate-500 transition-all">ä¸´æ—¶</button>
                </div>
                <div id="task-list" class="space-y-3"></div>
            </section>

            <!-- AI åŠ©æ‰‹ -->
            <section id="ai-assistant" class="hidden space-y-6 page-fade-in">
                <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100 text-center">
                    <div class="w-16 h-16 bg-blue-50 rounded-3xl flex items-center justify-center text-3xl mx-auto mb-4">âœ¨</div>
                    <h2 class="text-xl font-black">AI æ™ºèƒ½æ•™ç»ƒ</h2>
                    <p class="text-xs text-slate-400 mt-2">åŸºäº Gemini 2.5 ä¸ºæ‚¨åˆ†æèº«ä½“å¯†ç </p>
                </div>

                <div class="bg-white rounded-3xl p-6 border border-slate-100 space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2">ğŸ¥— é¥®é£Ÿåˆ†æ</h3>
                    </div>
                    <textarea id="ai-diet-input" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-xs font-medium outline-none h-24 focus:ring-2 focus:ring-blue-100" placeholder="åƒäº†ä»€ä¹ˆï¼ŸAI ä¼šåˆ†æçƒ­é‡å’Œå‡è¡¡åº¦..."></textarea>
                    <button onclick="analyzeDiet()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-100 active:scale-95 transition-transform flex justify-center items-center gap-2 text-sm">å¼€å§‹ AI ç‚¹è¯„</button>
                    <div id="ai-diet-result" class="hidden text-xs text-slate-600 leading-relaxed bg-blue-50 p-4 rounded-2xl border border-blue-100"></div>
                </div>

                <button onclick="getBreakthroughAdvice()" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-bold shadow-xl active:scale-95 transition-all text-sm flex items-center justify-center gap-2">âš¡ ç ´è§£ä½“é‡é”šç‚¹å»ºè®®</button>
                <div id="ai-break-result" class="hidden text-xs text-slate-600 leading-relaxed bg-indigo-50 p-5 rounded-3xl border border-indigo-100"></div>
            </section>

            <!-- è®¾ç½® -->
            <section id="settings" class="hidden space-y-6 page-fade-in">
                <h2 class="text-2xl font-black text-slate-800">è®¾ç½®</h2>
                <div class="bg-white rounded-3xl p-6 border border-slate-100 space-y-6">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">ç›®æ ‡ä½“é‡ (kg)</label>
                        <input type="number" id="target-weight" step="0.1" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-lg font-black outline-none">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Gemini API Key</label>
                        <input type="password" id="user-api-key" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-medium outline-none" placeholder="åœ¨æ­¤å¡«å…¥ä½ çš„ API Key">
                    </div>
                    <button onclick="saveSettings()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold active:scale-95 transition-all">ä¿å­˜å¹¶åº”ç”¨</button>
                </div>
                <div class="bg-red-50 rounded-3xl p-6 border border-red-100">
                    <button onclick="resetApp()" class="text-xs text-red-400 underline font-bold">é‡ç½®åº”ç”¨å¹¶æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®</button>
                </div>
            </section>
        </main>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <nav class="fixed-in-container bottom-0 bg-white/90 backdrop-blur-lg border-t border-slate-100 px-6 pt-3 pb-6 safe-bottom z-30">
            <div class="flex justify-between items-center">
                <button onclick="showSection('dashboard')" id="nav-dashboard" class="flex-1 flex flex-col items-center gap-1 text-blue-600">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
                    <span class="text-[9px] font-black uppercase tracking-tighter">é¦–é¡µ</span>
                </button>
                <button onclick="showSection('daily-log')" id="nav-daily-log" class="flex-1 flex flex-col items-center gap-1 text-slate-400">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    <span class="text-[9px] font-black uppercase tracking-tighter">è®°å½•</span>
                </button>
                <button onclick="showSection('tasks')" id="nav-tasks" class="flex-1 flex flex-col items-center gap-1 text-slate-400">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><circle cx="3" cy="6" r="1"/><circle cx="3" cy="12" r="1"/><circle cx="3" cy="18" r="1"/></svg>
                    <span class="text-[9px] font-black uppercase tracking-tighter">è®¡åˆ’</span>
                </button>
                <button onclick="showSection('history')" id="nav-history" class="flex-1 flex flex-col items-center gap-1 text-slate-400">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span class="text-[9px] font-black uppercase tracking-tighter">å†å²</span>
                </button>
                <button onclick="showSection('settings')" id="nav-settings" class="flex-1 flex flex-col items-center gap-1 text-slate-400">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                    <span class="text-[9px] font-black uppercase tracking-tighter">æˆ‘çš„</span>
                </button>
            </div>
        </nav>

        <!-- ä»»åŠ¡æ¨¡æ€æ¡† -->
        <div id="task-modal" class="absolute inset-0 bg-black/40 z-50 hidden flex items-end">
            <div class="bg-white w-full rounded-t-[3rem] p-8 space-y-6 transform translate-y-full transition-transform duration-300">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-black">æ–°å¢è®¡åˆ’</h3>
                    <button onclick="closeModal('task-modal')" class="p-2 bg-slate-100 rounded-full text-slate-400">âœ•</button>
                </div>
                <div class="space-y-4">
                    <input type="text" id="new-task-title" class="w-full bg-slate-50 border-none rounded-2xl p-4 font-bold outline-none" placeholder="å†…å®¹ (å¦‚: æ™šä¸Šä¸åƒä¸»é£Ÿ)">
                    <div class="flex gap-4">
                        <select id="new-task-type" class="flex-1 bg-slate-50 border-none rounded-2xl p-4 font-bold outline-none">
                            <option value="daily">æ¯æ—¥æƒ¯ä¾‹</option>
                            <option value="temp">ä¸´æ—¶ä»»åŠ¡</option>
                        </select>
                        <input type="time" id="new-task-time" class="flex-1 bg-slate-50 border-none rounded-2xl p-4 font-bold outline-none">
                    </div>
                    <button onclick="addTask()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold mt-4">ç¡®è®¤</button>
                </div>
            </div>
        </div>

        <div id="weight-modal" class="absolute inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 space-y-6 transform scale-90 transition-all">
                <h3 class="text-lg font-black text-center">è®°å½•ä½“é‡</h3>
                <div class="relative">
                    <input type="number" id="new-weight-val" step="0.1" class="w-full bg-slate-50 border-none rounded-3xl p-6 text-center text-4xl font-black text-blue-600 outline-none" placeholder="0.0">
                    <span class="absolute right-6 top-1/2 -translate-y-1/2 text-slate-300 font-bold">kg</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeModal('weight-modal')" class="flex-1 py-4 rounded-2xl font-bold bg-slate-50 text-slate-400">å–æ¶ˆ</button>
                    <button onclick="confirmWeight()" class="flex-1 py-4 rounded-2xl font-bold bg-blue-600 text-white shadow-lg">æäº¤</button>
                </div>
            </div>
        </div>

        <div id="toast" class="absolute top-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full text-[10px] font-bold shadow-2xl opacity-0 transition-opacity pointer-events-none z-50 uppercase tracking-widest"></div>
    </div>

    <script>
        // --- æ ¸å¿ƒçŠ¶æ€ ---
        const DEFAULT_STATE = {
            tasks: [
                { id: 1, title: 'æ™¨èµ·ç§°é‡', type: 'daily', time: '07:00', done: false },
                { id: 2, title: 'ç©ºè…¹é¥®æ°´ 500ml', type: 'daily', time: '07:15', done: false }
            ],
            weightLogs: [{ date: '2024-01-01', weight: 70.0 }],
            dailyLogs: {},
            settings: { targetWeight: 65.0, apiKey: '' },
            currentFilter: 'daily',
            historyMode: 'card' // card æˆ– table
        };

        const FITNESS_TIPS = [
            "è‚Œè‚‰çš„å¯†åº¦æ¯”è„‚è‚ªå¤§ï¼Œæ‰€ä»¥ä½“é‡ä¸é™å¹¶ä¸ä»£è¡¨ä½ æ²¡ç˜¦ï¼Œè…°å›´æ›´æœ‰å‚è€ƒä»·å€¼ã€‚",
            "åŠ›é‡è®­ç»ƒèƒ½æé«˜é™æ¯ä»£è°¢ç‡ï¼Œè®©ä½ åœ¨ç¡è§‰æ—¶ä¹Ÿæ¶ˆè€—æ›´å¤šçƒ­é‡ã€‚",
            "æ°´æ˜¯ä»£è°¢çš„åª’ä»‹ã€‚è„±æ°´ä¼šå¯¼è‡´ä»£è°¢ç‡ä¸‹é™ï¼Œæ¯å¤©ä¿è¯ 2-3 å‡æ°´å¯¹å‡è„‚è‡³å…³é‡è¦ã€‚",
            "æ‰“ç ´ä½“é‡çš„â€˜è°ƒå®šç‚¹â€™éœ€è¦æ—¶é—´ï¼Œé€šå¸¸èº«ä½“éœ€è¦ 3-6 ä¸ªæœˆæ‰èƒ½é€‚åº”ä¸€ä¸ªæ–°ä½“é‡ã€‚"
        ];

        let state = JSON.parse(localStorage.getItem('BODY_MASTER_DATA_V3')) || DEFAULT_STATE;

        function saveToLocal() {
            localStorage.setItem('BODY_MASTER_DATA_V3', JSON.stringify(state));
        }

        function getTodayStr() {
            return new Date().toLocaleDateString('zh-CN', { year:'numeric', month:'2-digit', day:'2-digit' }).replace(/\//g, '-');
        }

        function showSection(id) {
            ['dashboard', 'tasks', 'settings', 'ai-assistant', 'history', 'daily-log'].forEach(sec => {
                const el = document.getElementById(sec);
                if(el) el.classList.add('hidden');
                const nav = document.getElementById('nav-' + sec);
                if(nav) nav.classList.replace('text-blue-600', 'text-slate-400');
            });

            document.getElementById(id).classList.remove('hidden');
            if (document.getElementById('nav-' + id)) {
                document.getElementById('nav-' + id).classList.replace('text-slate-400', 'text-blue-600');
            }
            
            if (id === 'dashboard' && weightChart) setTimeout(() => weightChart.resize(), 50);
            if (id === 'history') renderHistory();
            if (id === 'daily-log') fillDailyLogInputs();
        }

        // --- æŸ¥çœ‹æ¨¡å¼åˆ‡æ¢ ---
        function changeHistoryMode(mode) {
            state.historyMode = mode;
            saveToLocal();
            renderHistory();
        }

        // --- å†å²é€»è¾‘ ---
        function renderHistory() {
            const container = document.getElementById('history-container');
            const modeCard = document.getElementById('mode-card');
            const modeTable = document.getElementById('mode-table');

            // åˆ‡æ¢æŒ‰é’®é«˜äº®
            if(state.historyMode === 'card') {
                modeCard.className = 'p-1.5 rounded-lg transition-all bg-white shadow-sm text-blue-600';
                modeTable.className = 'p-1.5 rounded-lg transition-all text-slate-400';
            } else {
                modeTable.className = 'p-1.5 rounded-lg transition-all bg-white shadow-sm text-blue-600';
                modeCard.className = 'p-1.5 rounded-lg transition-all text-slate-400';
            }

            const allDates = new Set([
                ...state.weightLogs.map(l => l.date),
                ...Object.keys(state.dailyLogs)
            ]);
            const sortedDates = Array.from(allDates).sort().reverse();

            if (sortedDates.length === 0) {
                container.innerHTML = '<p class="text-center py-20 text-slate-300 font-bold">æš‚æ— å†å²è®°å½•</p>';
                return;
            }

            if (state.historyMode === 'card') {
                container.innerHTML = sortedDates.map(date => {
                    const weightLog = state.weightLogs.find(l => l.date === date);
                    const dailyLog = state.dailyLogs[date];
                    return `
                        <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 space-y-3 page-fade-in">
                            <div class="flex justify-between items-center" onclick="toggleHistoryDetail('${date}')">
                                <div>
                                    <span class="text-xs font-black text-slate-800">${date}</span>
                                    <span class="ml-2 text-[10px] text-blue-600 font-bold uppercase tracking-wider">${weightLog ? weightLog.weight + 'kg' : ''}</span>
                                </div>
                                <svg id="icon-${date}" class="w-4 h-4 text-slate-300 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div id="detail-${date}" class="hidden space-y-4 pt-2 border-t border-slate-50">
                                ${dailyLog?.sleep?.h ? `<div class="flex gap-2"><span class="text-[10px] bg-indigo-50 text-indigo-500 px-2 py-0.5 rounded-full font-bold">ç¡çœ </span><p class="text-[11px] text-slate-600">${dailyLog.sleep.h}h (è´¨é‡:${dailyLog.sleep.q}/5)</p></div>` : ''}
                                ${dailyLog?.exercise ? `<div class="flex gap-2"><span class="text-[10px] bg-green-50 text-green-500 px-2 py-0.5 rounded-full font-bold">è¿åŠ¨</span><p class="text-[11px] text-slate-600">${dailyLog.exercise}</p></div>` : ''}
                                ${dailyLog?.diet?.b || dailyLog?.diet?.l ? `<div class="space-y-1"><span class="text-[10px] bg-orange-50 text-orange-500 px-2 py-0.5 rounded-full font-bold inline-block mb-1">é¥®é£Ÿ</span><p class="text-[11px] text-slate-500 ml-2">æ—©: ${dailyLog.diet.b || '-'}</p><p class="text-[11px] text-slate-500 ml-2">åˆ: ${dailyLog.diet.l || '-'}</p></div>` : ''}
                                <button onclick="deleteHistoryDay('${date}')" class="text-[10px] text-red-300 font-bold block pt-2">åˆ é™¤è®°å½•</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // è¡¨æ ¼æ¨¡å¼
                container.innerHTML = `
                    <div class="bg-white rounded-3xl overflow-hidden border border-slate-100 shadow-sm overflow-x-auto page-fade-in no-scrollbar">
                        <table class="history-table">
                            <thead>
                                <tr class="bg-slate-50">
                                    <th class="text-left">æ—¥æœŸ</th>
                                    <th>ä½“é‡</th>
                                    <th>ç¡çœ </th>
                                    <th>é¥®é£Ÿ</th>
                                    <th>è¿åŠ¨</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedDates.map(date => {
                                    const weightLog = state.weightLogs.find(l => l.date === date);
                                    const dailyLog = state.dailyLogs[date];
                                    const dietSummary = dailyLog ? [dailyLog.diet?.b, dailyLog.diet?.l, dailyLog.diet?.d].filter(x=>x).join(',') : '-';
                                    return `
                                        <tr>
                                            <td class="font-bold text-slate-500">${date.slice(5)}</td>
                                            <td class="font-black text-blue-600 text-center">${weightLog ? weightLog.weight : '--'}</td>
                                            <td class="text-center text-slate-400">${dailyLog?.sleep?.h ? dailyLog.sleep.h + 'h' : '--'}</td>
                                            <td class="max-w-[80px] truncate text-slate-400">${dietSummary || '--'}</td>
                                            <td class="max-w-[80px] truncate text-slate-400">${dailyLog?.exercise || '--'}</td>
                                            <td class="text-center">
                                                <button onclick="deleteHistoryDay('${date}')" class="text-red-300">âœ•</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }

        function toggleHistoryDetail(date) {
            const el = document.getElementById(`detail-${date}`);
            const icon = document.getElementById(`icon-${date}`);
            if(!el || !icon) return;
            const isHidden = el.classList.contains('hidden');
            el.classList.toggle('hidden');
            icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function deleteHistoryDay(date) {
            if(confirm(`ç¡®å®šåˆ é™¤ ${date} çš„æ‰€æœ‰è®°å½•å—ï¼Ÿ`)) {
                state.weightLogs = state.weightLogs.filter(l => l.date !== date);
                delete state.dailyLogs[date];
                saveToLocal();
                renderHistory();
                renderDashboard();
                if(weightChart) updateChart();
            }
        }

        // --- å…¶å®ƒé€»è¾‘ ---
        function fillDailyLogInputs() {
            const today = getTodayStr();
            const log = state.dailyLogs[today] || { sleep: {h:'', q:''}, diet: {b:'', l:'', d:'', s:''}, exercise: '' };
            document.getElementById('log-sleep-hours').value = log.sleep?.h || '';
            document.getElementById('log-sleep-quality').value = log.sleep?.q || '';
            document.getElementById('log-diet-breakfast').value = log.diet?.b || '';
            document.getElementById('log-diet-lunch').value = log.diet?.l || '';
            document.getElementById('log-diet-dinner').value = log.diet?.d || '';
            document.getElementById('log-diet-snack').value = log.diet?.s || '';
            document.getElementById('log-exercise-content').value = log.exercise || '';
        }

        function saveDailyLog() {
            const today = getTodayStr();
            state.dailyLogs[today] = {
                sleep: { h: document.getElementById('log-sleep-hours').value, q: document.getElementById('log-sleep-quality').value },
                diet: { b: document.getElementById('log-diet-breakfast').value, l: document.getElementById('log-diet-lunch').value, d: document.getElementById('log-diet-dinner').value, s: document.getElementById('log-diet-snack').value },
                exercise: document.getElementById('log-exercise-content').value
            };
            saveToLocal();
            showToast("ä»Šæ—¥è®°å½•å·²åŒæ­¥");
            showSection('dashboard');
        }

        function renderDashboard() {
            const done = state.tasks.filter(t => t.done).length;
            const rate = state.tasks.length > 0 ? Math.round((done / state.tasks.length) * 100) : 0;
            document.getElementById('execution-rate').innerText = rate + '%';
            document.getElementById('execution-bar').style.width = rate + '%';
            const current = state.weightLogs[state.weightLogs.length - 1].weight;
            document.getElementById('current-weight-display').innerText = current ? current.toFixed(1) : '--';
            const diff = (current - (state.weightLogs[state.weightLogs.length - 2]?.weight || current)).toFixed(1);
            const diffEl = document.getElementById('weight-diff');
            diffEl.innerText = diff > 0 ? `+${diff} kg` : diff < 0 ? `${diff} kg` : 'æŒå¹³';
            diffEl.className = `text-[10px] mt-2 font-black ${diff > 0 ? 'text-red-400' : diff < 0 ? 'text-emerald-400' : 'text-slate-300'}`;
            document.getElementById('quick-tasks').innerHTML = state.tasks.filter(t => !t.done).map(t => `
                <div class="flex-shrink-0 w-32 bg-white p-4 rounded-[1.5rem] border border-slate-100 shadow-sm" onclick="toggleTask(${t.id})">
                    <p class="text-[10px] font-black text-slate-800 truncate uppercase tracking-tight">${t.title}</p>
                    <p class="text-[9px] text-slate-300 font-bold mt-1">${t.time}</p>
                </div>
            `).join('') || '<p class="text-[10px] text-slate-300 font-bold p-4">ä»Šæ—¥å·²é€šå…³!</p>';
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            const filtered = state.tasks.filter(t => t.type === state.currentFilter);
            list.innerHTML = filtered.map(t => `
                <div class="bg-white p-5 rounded-3xl flex items-center gap-4 shadow-sm" onclick="toggleTask(${t.id})">
                    <div class="w-6 h-6 rounded-full border-4 ${t.done ? 'bg-blue-600 border-blue-100' : 'border-slate-50'} transition-all"></div>
                    <div class="flex-1"><p class="text-xs font-black text-slate-700 ${t.done ? 'task-done' : ''}">${t.title}</p><p class="text-[9px] text-slate-300 font-bold uppercase">${t.time}</p></div>
                    <button onclick="deleteTask(event, ${t.id})" class="text-slate-200 text-xs">âœ•</button>
                </div>
            `).join('');
        }

        function toggleTask(id) {
            const t = state.tasks.find(x => x.id === id);
            if(t) { t.done = !t.done; saveToLocal(); renderTasks(); renderDashboard(); }
        }

        function addTask() {
            const title = document.getElementById('new-task-title').value;
            if(!title) return;
            state.tasks.push({ id: Date.now(), title, type: document.getElementById('new-task-type').value, time: document.getElementById('new-task-time').value || '--:--', done: false });
            saveToLocal(); closeModal('task-modal'); renderTasks(); renderDashboard();
        }

        function deleteTask(e, id) { e.stopPropagation(); state.tasks = state.tasks.filter(t => t.id !== id); saveToLocal(); renderTasks(); renderDashboard(); }

        function toggleTaskFilter(type) {
            state.currentFilter = type;
            document.getElementById('tab-daily').className = `flex-1 py-2.5 rounded-xl text-xs font-bold ${type==='daily'?'bg-white shadow-sm text-blue-600':'text-slate-500'}`;
            document.getElementById('tab-temp').className = `flex-1 py-2.5 rounded-xl text-xs font-bold ${type==='temp'?'bg-white shadow-sm text-blue-600':'text-slate-500'}`;
            renderTasks();
        }

        function confirmWeight() {
            const v = parseFloat(document.getElementById('new-weight-val').value);
            if(v > 0) {
                const today = getTodayStr();
                const existingIndex = state.weightLogs.findIndex(l => l.date === today);
                if(existingIndex > -1) state.weightLogs[existingIndex].weight = v;
                else state.weightLogs.push({ date: today, weight: v });
                if(state.weightLogs.length > 365) state.weightLogs.shift();
                saveToLocal(); closeModal('weight-modal'); updateChart(); renderDashboard();
            }
        }

        function saveSettings() {
            state.settings.targetWeight = parseFloat(document.getElementById('target-weight').value);
            state.settings.apiKey = document.getElementById('user-api-key').value;
            saveToLocal(); showToast('è®¾ç½®å·²ä¿å­˜'); showSection('dashboard');
        }

        function renderFitnessTip() {
            const tip = FITNESS_TIPS[Math.floor(Math.random() * FITNESS_TIPS.length)];
            document.getElementById('fitness-tip-content').textContent = tip;
        }

        function initChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: state.weightLogs.slice(-14).map(l => l.date.slice(-5)),
                    datasets: [{ data: state.weightLogs.slice(-14).map(l => l.weight), borderColor: '#2563eb', borderWidth: 4, tension: 0.4, fill: false, pointRadius: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 8, weight: 'bold' }, color: '#cbd5e1' } } } }
            });
        }
        function updateChart() { 
            weightChart.data.labels = state.weightLogs.slice(-14).map(l => l.date.slice(-5)); 
            weightChart.data.datasets[0].data = state.weightLogs.slice(-14).map(l => l.weight); 
            weightChart.update(); 
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); setTimeout(()=>document.getElementById(id).firstElementChild.classList.remove('translate-y-full', 'scale-90'), 10); }
        function closeModal(id) { document.getElementById(id).firstElementChild.classList.add('translate-y-full', 'scale-90'); setTimeout(()=>document.getElementById(id).classList.add('hidden'), 300); }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.replace('opacity-0', 'opacity-100'); setTimeout(()=>t.classList.replace('opacity-100', 'opacity-0'), 2000); }
        function resetApp() { if(confirm("ç¡®å®šè¦é‡ç½®å—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
        function addWeightLog() { openModal('weight-modal'); }

        window.onload = () => {
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', weekday: 'short' });
            document.getElementById('target-weight').value = state.settings.targetWeight;
            document.getElementById('user-api-key').value = state.settings.apiKey;
            renderDashboard();
            renderTasks();
            renderFitnessTip();
            initChart();
        };
    </script>
</body>
</html>
